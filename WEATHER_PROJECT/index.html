<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="./styles.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    
    <title>Centre météo</title>
</head>
<body onload="addUsers()">
    <div id="map">    
    </div>

    <script> 
           
        var map = L.map('map').setView([48.86, 2.33], 6);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var sunIcon = L.icon({
            iconUrl: 'sun.png',
            iconSize:     [32, 32], // size of the icon
        });

        var rainIcon = L.icon({
            iconUrl: 'rain.png',
            iconSize:     [32, 32], // size of the icon
        });
        
        var cloudIcon = L.icon({
            iconUrl: 'cloud.png',
            iconSize:     [32, 32], // size of the icon
        });
 
        function addUsers(){
            let users = [];

            const oneSecondInterval = setInterval(() => {
                fetch("https://randomuser.me/api/?nat=fr").then(function(response) {
                    return response.json();
                }).then(function(data) {
                    let name = (data.results[0].name.first).concat(" ",data.results[0].name.last);
                    let city = data.results[0].location.city;
                 
                    fetch("https://geocoding-api.open-meteo.com/v1/search?name="+city).then(function(response) {
                        return response.json();
                    }).then(function(data){
                        indexData = 0;
                        while(data.results[indexData].country_code != "FR"){
                            indexData++;
                        }
                        lat = data.results[indexData].latitude;
                        lon = data.results[indexData].longitude;
                        newLoc = [lat,lon];
                        fetch("https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&current_weather=true").then(function(response){
                            return response.json();
                        }).then(function(dataWeather){
                            temperature = dataWeather.current_weather.temperature;
                            code = dataWeather.current_weather.weathercode;

                            if (users.length >= 10) {
                                map.removeLayer(users.shift());
                            }

                            let icon = sunIcon;

                            switch(code){
                                case 0:
                                case 1:
                                case 2:
                                case 3:
                                    //clear sky
                                    icon = sunIcon;
                                    break;
                                case 45:
                                case 48:
                                    //fog
                                    icon = rainIcon;
                                    break;
                                case 51:
                                case 53:
                                case 55:
                                    //drizzle
                                    icon = rainIcon;
                                    break;
                                case 56:
                                case 57:
                                    //freezing drizzle
                                    icon = rainIcon;
                                    break;
                                case 61:
                                default:
                                    icon = sunIcon;
                                    break;
                            }

                            const newUserLocation = L.marker(newLoc, {icon:icon}).addTo(map).bindPopup(`<span class="city">${city}</span> ${name} <br> <span id="temp">${temperature}</span>`, { autoClose: true, autoPan: false }, { className: 'marketStyle' });
                            users.push(newUserLocation);

                           
                        }).catch(function(err) {
                            console.log('Fetch Error :-S', err);
                        });
                }).catch(function(err) {
                    console.log('Fetch Error :-S', err);
                });
                }) 
            }, 1000); 
        }

        
     

    </script>
</body>
</html>